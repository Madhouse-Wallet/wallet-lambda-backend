const { ethers } = require("ethers");
const connectToDatabase = require("../db");
const collateralDataServices = require("../services/collateralDataServices")

//const nodemailer = require("nodemailer");

// Configuration
//const RPC_URL = "https://1rpc.io/eth";
const RPC_URL = "https://sepolia.gateway.tenderly.co";
const CONTRACT_ADDRESS = "0x4D74b0eFfa314a79dFd324C129D5b29c11ADbb04";
//const CONTRACT_ADDRESS = "0xfC7d41A684b7dB7c817A9dDd028f9A31c2F6f893";
const CHAINLINK_BTC_USD_FEED = "0x694AA1769357215DE4FAC081bf1f309aDC325306";

//const CHAINLINK_BTC_USD_FEED = "0xF4030086522a5bEEa4988F8cA5B36dbC97BeE88c";
const CONTRACT_ABI = [{ "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_activePoolAddress", "type": "address" }], "name": "ActivePoolAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "_baseRate", "type": "uint256" }], "name": "BaseRateUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_newBorrowerOperationsAddress", "type": "address" }], "name": "BorrowerOperationsAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_collSurplusPoolAddress", "type": "address" }], "name": "CollSurplusPoolAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_defaultPoolAddress", "type": "address" }], "name": "DefaultPoolAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_gasPoolAddress", "type": "address" }], "name": "GasPoolAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "_L_Collateral", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_L_THUSDDebt", "type": "uint256" }], "name": "LTermsUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "_lastFeeOpTime", "type": "uint256" }], "name": "LastFeeOpTimeUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "_liquidatedDebt", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_liquidatedColl", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_collGasCompensation", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_THUSDGasCompensation", "type": "uint256" }], "name": "Liquidation", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_pcvAddress", "type": "address" }], "name": "PCVAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_newPriceFeedAddress", "type": "address" }], "name": "PriceFeedAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "_attemptedTHUSDAmount", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_actualTHUSDAmount", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_collateralSent", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_collateralFee", "type": "uint256" }], "name": "Redemption", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_sortedTrovesAddress", "type": "address" }], "name": "SortedTrovesAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_stabilityPoolAddress", "type": "address" }], "name": "StabilityPoolAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "_totalStakesSnapshot", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_totalCollateralSnapshot", "type": "uint256" }], "name": "SystemSnapshotsUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_newTHUSDTokenAddress", "type": "address" }], "name": "THUSDTokenAddressChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "_newTotalStakes", "type": "uint256" }], "name": "TotalStakesUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "_borrower", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "_newIndex", "type": "uint256" }], "name": "TroveIndexUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "_borrower", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "_debt", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_coll", "type": "uint256" }, { "indexed": false, "internalType": "enum TroveManager.TroveManagerOperation", "name": "_operation", "type": "uint8" }], "name": "TroveLiquidated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "_L_Collateral", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_L_THUSDDebt", "type": "uint256" }], "name": "TroveSnapshotsUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "_borrower", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "_debt", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_coll", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "_stake", "type": "uint256" }, { "indexed": false, "internalType": "enum TroveManager.TroveManagerOperation", "name": "_operation", "type": "uint8" }], "name": "TroveUpdated", "type": "event" }, { "inputs": [], "name": "BETA", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "BORROWING_FEE_FLOOR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "CCR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "DECIMAL_PRECISION", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "L_Collateral", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "L_THUSDDebt", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MAX_BORROWING_FEE", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MCR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MINUTE_DECAY_FACTOR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MIN_NET_DEBT", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "NAME", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "PERCENT_DIVISOR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "REDEMPTION_FEE_FLOOR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "THUSD_GAS_COMPENSATION", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "TroveOwners", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "Troves", "outputs": [{ "internalType": "uint256", "name": "debt", "type": "uint256" }, { "internalType": "uint256", "name": "coll", "type": "uint256" }, { "internalType": "uint256", "name": "stake", "type": "uint256" }, { "internalType": "enum ITroveManager.Status", "name": "status", "type": "uint8" }, { "internalType": "uint128", "name": "arrayIndex", "type": "uint128" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "_100pct", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "activePool", "outputs": [{ "internalType": "contract IActivePool", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "addTroveOwnerToArray", "outputs": [{ "internalType": "uint256", "name": "index", "type": "uint256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "applyPendingRewards", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "baseRate", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address[]", "name": "_troveArray", "type": "address[]" }], "name": "batchLiquidateTroves", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "borrowerOperationsAddress", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_price", "type": "uint256" }], "name": "checkRecoveryMode", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "closeTrove", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "decayBaseRateFromBorrowing", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }, { "internalType": "uint256", "name": "_collDecrease", "type": "uint256" }], "name": "decreaseTroveColl", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }, { "internalType": "uint256", "name": "_debtDecrease", "type": "uint256" }], "name": "decreaseTroveDebt", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "defaultPool", "outputs": [{ "internalType": "contract IDefaultPool", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_THUSDDebt", "type": "uint256" }], "name": "getBorrowingFee", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_THUSDDebt", "type": "uint256" }], "name": "getBorrowingFeeWithDecay", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getBorrowingRate", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getBorrowingRateWithDecay", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }, { "internalType": "uint256", "name": "_price", "type": "uint256" }], "name": "getCurrentICR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "getEntireDebtAndColl", "outputs": [{ "internalType": "uint256", "name": "debt", "type": "uint256" }, { "internalType": "uint256", "name": "coll", "type": "uint256" }, { "internalType": "uint256", "name": "pendingTHUSDDebtReward", "type": "uint256" }, { "internalType": "uint256", "name": "pendingCollateralReward", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getEntireSystemColl", "outputs": [{ "internalType": "uint256", "name": "entireSystemColl", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getEntireSystemDebt", "outputs": [{ "internalType": "uint256", "name": "entireSystemDebt", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "getNominalICR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "getPendingCollateralReward", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "getPendingTHUSDDebtReward", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_collateralDrawn", "type": "uint256" }], "name": "getRedemptionFeeWithDecay", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getRedemptionRate", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getRedemptionRateWithDecay", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_price", "type": "uint256" }], "name": "getTCR", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "getTroveColl", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "getTroveDebt", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_index", "type": "uint256" }], "name": "getTroveFromTroveOwnersArray", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getTroveOwnersCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "getTroveStake", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "getTroveStatus", "outputs": [{ "internalType": "enum ITroveManager.Status", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "hasPendingRewards", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }, { "internalType": "uint256", "name": "_collIncrease", "type": "uint256" }], "name": "increaseTroveColl", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }, { "internalType": "uint256", "name": "_debtIncrease", "type": "uint256" }], "name": "increaseTroveDebt", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "isOwner", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "lastCollateralError_Redistribution", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "lastFeeOperationTime", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "lastTHUSDDebtError_Redistribution", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "liquidate", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_n", "type": "uint256" }], "name": "liquidateTroves", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "pcv", "outputs": [{ "internalType": "contract IPCV", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "priceFeed", "outputs": [{ "internalType": "contract IPriceFeed", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_THUSDamount", "type": "uint256" }, { "internalType": "address", "name": "_firstRedemptionHint", "type": "address" }, { "internalType": "address", "name": "_upperPartialRedemptionHint", "type": "address" }, { "internalType": "address", "name": "_lowerPartialRedemptionHint", "type": "address" }, { "internalType": "uint256", "name": "_partialRedemptionHintNICR", "type": "uint256" }, { "internalType": "uint256", "name": "_maxIterations", "type": "uint256" }, { "internalType": "uint256", "name": "_maxFeePercentage", "type": "uint256" }], "name": "redeemCollateral", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "removeStake", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "rewardSnapshots", "outputs": [{ "internalType": "uint256", "name": "collateral", "type": "uint256" }, { "internalType": "uint256", "name": "THUSDDebt", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrowerOperationsAddress", "type": "address" }, { "internalType": "address", "name": "_activePoolAddress", "type": "address" }, { "internalType": "address", "name": "_defaultPoolAddress", "type": "address" }, { "internalType": "address", "name": "_stabilityPoolAddress", "type": "address" }, { "internalType": "address", "name": "_gasPoolAddress", "type": "address" }, { "internalType": "address", "name": "_collSurplusPoolAddress", "type": "address" }, { "internalType": "address", "name": "_priceFeedAddress", "type": "address" }, { "internalType": "address", "name": "_thusdTokenAddress", "type": "address" }, { "internalType": "address", "name": "_sortedTrovesAddress", "type": "address" }, { "internalType": "address", "name": "_pcvAddress", "type": "address" }], "name": "setAddresses", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }, { "internalType": "enum ITroveManager.Status", "name": "_status", "type": "uint8" }], "name": "setTroveStatus", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "sortedTroves", "outputs": [{ "internalType": "contract ISortedTroves", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "stabilityPool", "outputs": [{ "internalType": "contract IStabilityPool", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "thusdToken", "outputs": [{ "internalType": "contract ITHUSDToken", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalCollateralSnapshot", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalStakes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalStakesSnapshot", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "updateStakeAndTotalStakes", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_borrower", "type": "address" }], "name": "updateTroveRewardSnapshots", "outputs": [], "stateMutability": "nonpayable", "type": "function" }];

const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
const btcPriceFeed = new ethers.Contract(
    CHAINLINK_BTC_USD_FEED,
    ["function latestRoundData() external view returns (uint80, int256, uint256, uint256, uint80)"],
    provider
);

// Email Configuration (Commented Out)
/*
const transporter = nodemailer.createTransport({
    service: "gmail", 
    auth: {
        user: "your-email@gmail.com", // Replace with your email
        pass: "your-app-password" // Use an App Password if using Gmail
    }
});

const sendEmail = async (recipient, subject, message) => {
    const mailOptions = {
        from: "your-email@gmail.com",
        to: recipient,
        subject: subject,
        text: message
    };
    try {
        await transporter.sendMail(mailOptions);
        console.log(`Email sent to ${recipient}`);
    } catch (error) {
        console.error("Error sending email:", error);
    }
};
*/
// Store triggered notifications
const sentLiquidationAlerts = new Set();
const sentRedemptionAlerts = new Set();

const fetchAllTroves = async () => {
    await connectToDatabase();
    let data = await collateralDataServices.getUniqueWallets()
    console.log("newdata --->", data)
    try {
        const [, answer] = await btcPriceFeed.latestRoundData();
        const btcPrice = answer.toString() / 1e8;
        console.log(`Current BTC Price: $${btcPrice.toLocaleString()}`);


        // const data = [
        //     "0x69F298492B268A7de631E672917BB8B87b039089",
        //     "0xd0236C05d6FcA23fbA40AFeC83DF7cE4188D48E3",
        //     "0x8f4A19C85b39032A37f7a6dCc65234f966F72551",
        //     "0x4Cf100cce352029e726185980E4611de835D6C7B",
        //     "0xd3844B17656b400a0baE933485c894ffE48Aa92E",
        //     "0x015509D3c2BC354be2EB006d31953B949168c082",
        //     "0x9A872029Ee44858EA17B79E30198947907a3a67A",
        //     "0x7C2277b9054B6Fa32790Eb1B6Eb2a43F62e27F8e",
        //     "0x37773285c5A3444CB4eBe4FCeffaf0512f260d65"
        // ];

        for (let i = 0; i < data.length; i++) {
            const troveOwner = data[i].walletAddress;  // Use the address from the array
            const troveData = await contract.Troves(troveOwner);

            const collateral = ethers.utils.formatEther(troveData.coll);
            const debt = ethers.utils.formatEther(troveData.debt);

            const collateralValueUSD = parseFloat(collateral) * btcPrice;
            const debtValue = parseFloat(debt);
            const collateralRatio = debtValue > 0 ? (collateralValueUSD / debtValue) * 100 : 0;

            console.log(`Trove ${troveOwner}: Collateral Ratio: ${collateralRatio.toFixed(1)}%`);
            console.log("data[i].email ===>",data[i].email)
            // Liquidation Protection Alert (One-time notification)
            const liquidationThresholds = [325, 345, 380];
            const band = 2;
            liquidationThresholds.forEach(threshold => {
                const lowerBound = threshold - band;
                const upperBound = threshold + band;
                if (collateralRatio >= lowerBound && collateralRatio <= upperBound && !sentLiquidationAlerts.has(threshold)) {
                    //Liquidation Protection  email send
                    console.log("data[i].email ===>",data[i].email)
                    console.log(
                        "User wallet address",
                        "Liquidation Protection Alert",
                        `Your trove's collateral ratio is at ${collateralRatio.toFixed(1)}%. Consider adjusting your collateral.`
                    );
                    sentLiquidationAlerts.add(threshold); // Mark this threshold as notified
                }
            });

            // Redemption Protection Alert (One-time notification)
            const redemptionThresholds = [410, 425, 450, 500];
            redemptionThresholds.forEach(threshold => {
                const lowerBound = threshold - band;
                const upperBound = threshold + band;
                if (collateralRatio >= lowerBound && collateralRatio <= upperBound && !sentRedemptionAlerts.has(threshold)) {
                    //Redemption Protection  email send
                    console.log("data[i].email ===>",data[i].email)
                    console.log(
                        "User wallet address",
                        "Redemption Protection Alert",
                        `Your trove's collateral ratio is at ${collateralRatio.toFixed(1)}%. This may impact redemptions.`
                    );
                    sentRedemptionAlerts.add(threshold); // Mark this threshold as notified
                }
            });
        }
    } catch (error) {
        console.error("Error fetching troves:", error);
    }
};
// Run the function every 60 seconds (1 minute)
// setInterval(fetchAllTroves, 30 * 1000); // 60 * 1000 milliseconds = 1 minute
fetchAllTroves();